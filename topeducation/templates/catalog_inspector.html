{% extends "base.html" %}

{% block title %}Inspector de Endpoints{% endblock %}
{% block header %}Inspector de Endpoints{% endblock %}

{% block content %}
<main class="bg-transparent text-slate-900">
  <div class="mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-2">

      <!-- ===================== LEFT PANEL ===================== -->
      <section class="lg:col-span-1 sticky top-0 max-h-[78vh] overflow-y-auto rounded-sm px-2 text-slate-100">

        <div class="space-y-3">
          <label class="block text-sm">
            Base URL
            <input id="base-input" type="text"
              value="https://erucsg6yrj.execute-api.us-east-1.amazonaws.com/colombia-endpoint/course-information"
              class="mt-1 w-full rounded-full border px-3 py-2 bg-neutral-700">
          </label>

          <label class="block text-sm">
            Recurso
            <select id="resource-select" class="mt-1 w-full rounded-full border px-3 py-2 bg-neutral-700">
              <option value="courses" selected>/courses</option>
            </select>
          </label>

          <div class="grid grid-cols-2 gap-2">
            <input id="page-input" type="number" value="1" min="1"
              class="rounded-full border px-3 py-2 bg-neutral-700">
            <input id="page-size-input" type="number" value="25" min="1" max="500"
              class="rounded-full border px-3 py-2 bg-neutral-700">
          </div>

          <div class="flex gap-2">
            <button id="reload" class="bg-[#F6F4EF] transition duration-300  hover:text-shadow-[0_35px_35px_rgb(255_255_255_/_0.25)] !text-[#1c1c1c] font-bold py-1 px-4 rounded-full">Consultar</button>
            <button id="sync-btn" class="bg-blue-600 px-3 py-1 rounded-full text-neutral-100">Sincronizar</button>
          </div>
        </div>

        <hr class="my-4">

        <div class="space-y-2 text-sm">
          <div><strong>URL:</strong> <code id="full-url"></code></div>
          <div><strong>Metadatos:</strong> <span id="meta">—</span></div>
          <div><strong>Estado:</strong> <span id="status">—</span></div>
        </div>

        <details open class="mt-4 border rounded-lg">
          <summary class="px-3 py-2 cursor-pointer">JSON</summary>
          <pre id="raw-json" class="p-3 text-xs overflow-auto max-h-64"></pre>
        </details>

        <details class="mt-2 border rounded-lg">
          <summary class="px-3 py-2 cursor-pointer">Primer item</summary>
          <pre id="example" class="p-3 text-xs overflow-auto"></pre>
        </details>

      </section>

      <!-- ===================== RIGHT PANEL ===================== -->
      <section class="lg:col-span-3 rounded-sm max-h-[77vh] px-3 text-slate-100">

        <div class="flex justify-between items-center mb-2">
          <input id="global-search" placeholder="Buscar..."
            class="rounded-lg border px-3 py-2 bg-neutral-800 w-64">
          <span id="count"></span>
        </div>

        <div class="overflow-auto max-h-[73vh]">
          <table class="min-w-full table-auto text-sm">
            <thead class="sticky top-0 bg-neutral-800">
              <tr id="thead-row"></tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

      </section>
    </div>
  </div>

<script>
(() => {

  /* ================= CONFIG ================= */
  // ⚠️ No usamos x-api-key en el front. El backend toma la key del .env.
  // Recomendado: usa un proxy dedicado para cursos, para no chocar con tu proxy_json existente.
  // Si tu ruta es /api/proxy/courses, déjalo así:
  const PROXY_PATH = "/api/proxy/courses/run";

  // Endpoint interno que ejecuta "1 página" tipo cron job manual.
  // Si ya lo migraste a /api/sync/courses/run, puedes cambiarlo aquí.
  const SYNC_URL = "{% url 'sync_courses_from_external' %}";

  const COURSE_COLUMNS = [
    "nombre",
    "tema_certificacion",
    "nivel_certificacion",
    "lenguaje_certificacion",
    "aprendizaje_certificacion",
    "habilidades_certificacion",
    "universidad_certificacion",
    "plataforma_certificacion",
    "url_certificacion_original",
    "imagen_final",
    "temas",
    "universidades",
    "plataformas"
  ];

  const $ = id => document.getElementById(id);
  let RAW = [];

  /* ================= UTILS ================= */
  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function renderHead() {
    $("thead-row").innerHTML = COURSE_COLUMNS.map(c =>
      `<th class="px-3 py-2 text-left whitespace-nowrap">${c}</th>`
    ).join("");
  }

  function renderTable() {
    const q = ($("global-search").value || "").toLowerCase();

    const rows = RAW.filter(r =>
      Object.values(r).some(v => String(v ?? "").toLowerCase().includes(q))
    );

    $("count").textContent = `rows=${rows.length}`;

    $("tbody").innerHTML = rows.map(row => {
      return `<tr>${
        COURSE_COLUMNS.map(c => {
          let value = row[c] ?? "";

          if (c === "imagen_final" && value) {
            return `<td class="px-3 py-2 border-t">
              <img src="${escapeHtml(value)}" class="h-10 w-10 rounded object-cover">
            </td>`;
          }

          return `<td class="px-3 py-2 border-t align-top">
            ${escapeHtml(value)}
          </td>`;
        }).join("")
      }</tr>`;
    }).join("");

    $("example").textContent = rows[0]
      ? JSON.stringify(rows[0], null, 2)
      : "{}";
  }

  // CSRF desde cookie (si tu SYNC_URL requiere CSRF)
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  }

  /* ================= PROXY LOAD ================= */
  async function loadFromProxy() {
    $("status").textContent = "Cargando...";
    RAW = [];
    renderTable();

    const page = $("page-input").value;
    const pageSize = $("page-size-input").value;

    const base = $("base-input").value.replace(/\/+$/,"");
    const resource = $("resource-select").value || "courses";

    // El externo usa page + pageSize (según tu ejemplo)
    const url = `${base}/${resource}?page=${page}&pageSize=${pageSize}`;
    $("full-url").textContent = url;

    try {
      // ✅ Solo llamamos al backend. Nada de x-api-key en el front.
      const res = await fetch(
        `${PROXY_PATH}?url=${encodeURIComponent(url)}`,
        { headers: { "Accept": "application/json" } }
      );

      const text = await res.text();
      let data = {};
      try { data = JSON.parse(text); } catch { data = { raw: text }; }

      $("raw-json").textContent = JSON.stringify(data, null, 2);

      if (!res.ok) {
        // Si el proxy no está enviando la API key bien, lo verás como 401/403 acá.
        $("status").textContent = `Error proxy HTTP ${res.status}`;
        $("meta").textContent = `page=${page} · pageSize=${pageSize}`;
        return;
      }

      let all = [];

      // Tu estructura actual:
      // data.items[] -> item.temas/universidades/plataformas + item.certificaciones[]
      if (Array.isArray(data.items)) {
        data.items.forEach(item => {
          const temas = (item.temas || []).map(t => t.nombre).join(", ");
          const unis  = (item.universidades || []).map(u => u.nombre).join(", ");
          const plats = (item.plataformas || []).map(p => p.nombre).join(", ");

          (item.certificaciones || []).forEach(c => {
            all.push({
              ...c,
              temas,
              universidades: unis,
              plataformas: plats
            });
          });
        });
      }

      RAW = all;
      $("status").textContent = `OK (proxy) · rows=${RAW.length}`;
      $("meta").textContent = `page=${page} · pageSize=${pageSize}`;
      renderTable();

    } catch (e) {
      $("status").textContent = "Error proxy";
      console.error(e);
    }
  }

  /* ================= SYNC ================= */
  async function syncInternal() {
    $("status").textContent = "Sincronizando...";

    const page = parseInt($("page-input").value || "1", 10);
    const pageSize = parseInt($("page-size-input").value || "25", 10);

    try {
      const res = await fetch(SYNC_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "X-CSRFToken": getCookie('csrftoken'),
        },
        body: JSON.stringify({ page, pageSize }),
        credentials: "same-origin",
      });

      const data = await res.json().catch(() => ({}));
      $("raw-json").textContent = JSON.stringify(data, null, 2);

      if (!res.ok || data.ok === false) {
        $("status").textContent = `Error sync (HTTP ${res.status})`;
        return;
      }

      $("status").textContent = `OK sync · page=${page} · received=${data.received ?? "?"} · next=${data.next_page ?? "?"}`;

      // ✅ recargar tabla después del sync
      await loadFromProxy();

    } catch (e) {
      $("status").textContent = "Error sync";
      console.error(e);
    }
  }

  /* ================= EVENTS ================= */
  $("reload").onclick = loadFromProxy;
  $("sync-btn").onclick = syncInternal;
  $("global-search").oninput = renderTable;

  renderHead();
  loadFromProxy();

})();
</script>
</main>
{% endblock %}
