{% extends "base.html" %}

{% block title %} Inspertor de Endpoints {% endblock %}
{% block header %} Inspertor de Endpoints {% endblock %}

{% block content %}
<main class="bg-trasparent text-slate-900">
  <div class="mx-auto ">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-3">
      <!-- Lado izquierdo -->
      <section class="lg:col-span-1 bg-neutral-950 border border-slate-200 rounded-2xl p-5 shadow-sm text-slate-100">
        <h2 class="text-base font-semibold mb-4 text-slate-100">Opciones</h2>
        <div class="space-y-3">
          <label class="block text-sm">
            <span class="text-slate-100">Base URL</span>
            <input id="base-input" type="text" value="https://erucsg6yrj.execute-api.us-east-1.amazonaws.com/colombia-endpoint/course-information"
                   class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-indigo-500 bg-neutral-950" />
          </label>

          <label class="block text-sm">
            <span class="text-slate-100">Recurso</span>
            <select id="resource-select"
                    class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm bg-neutral-950 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-indigo-500">
              <!-- nuevo endpoint principal -->
              <option value="courses" selected>/courses</option>
              <!-- otros recursos que ya tenías, por si siguen existiendo -->
              <option value="certifications">/certifications</option>
              <option value="topics">/topics</option>
              <option value="companies">/companies</option>
              <option value="universities">/universities</option>
              <option value="platforms">/platforms</option>
              <option value="regions">/regions</option>
            </select>
          </label>

          <!-- API KEY -->
          <label class="block text-sm">
            <span class="text-slate-100">API Key (x-api-key)</span>
            <input id="api-key-input" type="password" placeholder="Pega aquí tu API key…"
                   class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-indigo-500 bg-neutral-950" />
            <p class="mt-1 text-xs text-slate-400">
              Este valor se envía en el header <code>x-api-key</code>.
            </p>
          </label>

          <div class="flex items-center gap-2">
            <button id="reload" class="inline-flex items-center gap-2 rounded-lg border border-slate-300 px-3 py-2 text-sm hover:bg-neutral-950">
              Consultar
            </button>
            <button id="copy-url" class="inline-flex items-center gap-2 rounded-lg border border-slate-300 px-3 py-2 text-sm hover:bg-neutral-950">
              Copiar URL exacta
            </button>
          </div>
        </div>

        <div class="my-5 border-t border-slate-200"></div>

        <div class="space-y-3 ">
          <div>
            <h3 class="text-sm font-semibold text-slate-200">URL consultada</h3>
            <code id="full-url" class="block mt-1 text-xs font-mono text-slate-200 break-words"></code>
          </div>

          <div>
            <h3 class="text-sm font-semibold text-slate-200">Metadatos</h3>
            <p id="meta" class="mt-1 text-sm text-slate-100">—</p>
          </div>

          <div class="space-y-3">
            <details open class="rounded-xl border border-slate-200">
              <summary class="cursor-pointer select-none px-3 py-2 text-sm font-medium text-slate-200">Respuesta completa (JSON crudo)</summary>
              <pre id="raw-json" class="p-3 text-xs bg-neutral-950 overflow-auto" style="max-height: 260px;"></pre>
            </details>

            <details class="rounded-xl border border-slate-200">
              <summary class="cursor-pointer select-none px-3 py-2 text-sm font-medium text-slate-200">Primer item (muestra)</summary>
              <pre id="example" class="p-3 text-xs bg-neutral-950 overflow-auto"></pre>
            </details>
          </div>
        </div>
      </section>

      <!-- Lado derecho -->
      <section class="lg:col-span-3 bg-neutral-950 border border-slate-200 rounded-2xl p-5 shadow-sm">
        <div class="sticky top-0 bg-neutral-950 -m-5 p-5 rounded-t-2xl border-b border-slate-200 z-10 text-slate-100">
          <h2 class="text-base font-semibold">Datos</h2>
          <div class="mt-3 flex flex-wrap items-center gap-3">
            <input id="global-search" type="text" placeholder="Búsqueda global…"
                   class="w-full sm:w-64 rounded-lg border border-slate-300 px-3 py-2 text-sm bg-neutral-950 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-indigo-500" />

            <!-- INPUT: PAGE -->
            <div class="flex items-center gap-2">
              <label for="page-input" class="text-sm">Página:</label>
              <input
                id="page-input"
                type="number"
                min="1"
                value="1"
                class="w-16 rounded-lg border border-slate-300 px-2 py-1 text-sm bg-neutral-950 focus:outline-none focus:ring-2 focus:ring-blue-600 text-slate-100"
              />
            </div>

            <!-- INPUT: PAGE SIZE -->
            <div class="flex items-center gap-2">
              <label for="page-size-input" class="text-sm">Resultados:</label>
              <input
                id="page-size-input"
                type="number"
                min="1"
                max="500"
                value="25"
                class="w-20 rounded-lg border border-slate-300 px-2 py-1 text-sm bg-neutral-950 focus:outline-none focus:ring-2 focus:ring-blue-600 text-slate-100"
              />
            </div>

            <button id="apply-pagination" class="px-3 py-1 rounded-lg border border-slate-300 text-sm hover:bg-neutral-950">
              Aplicar
            </button>

            <span id="count" class="text-sm text-slate-100 ml-auto"></span>
          </div>
        </div>

        <div class="overflow-auto pt-[20px] text-slate-100" style="max-height: 70vh;">
          <table class="min-w-full table-auto">
            <thead class="sticky top-[0px] bg-neutral-950 z-10">
              <tr id="thead-row" class="text-left text-sm text-slate-100 border-b border-slate-200"></tr>
            </thead>
            <tbody id="tbody" class="divide-y divide-slate-100 text-sm"></tbody>
          </table>
        </div>

        <div class="mt-6 flex items-center gap-2 text-slate-100">
          <button id="prev" class="rounded-lg border border-slate-300 px-3 py-2 text-sm hover:bg-neutral-950 disabled:opacity-50">Anterior</button>
          <span id="page-info" class="text-sm text-slate-100"></span>
          <button id="next" class="rounded-lg border border-slate-300 px-3 py-2 text-sm hover:bg-neutral-950 disabled:opacity-50">Siguiente</button>
        </div>
      </section>
    </div>
  </div>

<script>
(function(){
  // DOM refs
  const baseInput     = document.getElementById('base-input');
  const resourceSel   = document.getElementById('resource-select');
  const apiKeyInput   = document.getElementById('api-key-input');
  const reloadBtn     = document.getElementById('reload');
  const copyBtn       = document.getElementById('copy-url');

  const fullUrl       = document.getElementById('full-url');
  const metaDiv       = document.getElementById('meta');
  const rawPre        = document.getElementById('raw-json');
  const examplePre    = document.getElementById('example');

  const theadRow      = document.getElementById('thead-row');
  const tbody         = document.getElementById('tbody');

  const globalSearch  = document.getElementById('global-search');
  const countLabel    = document.getElementById('count');
  const prevBtn       = document.getElementById('prev');
  const nextBtn       = document.getElementById('next');
  const pageInfo      = document.getElementById('page-info');

  const pageInput     = document.getElementById('page-input');
  const pageSizeInput = document.getElementById('page-size-input');
  const applyBtn      = document.getElementById('apply-pagination');

  // State
  let RAW = [];
  let COLUMNS = [];
  let PAGE = 1;
  let PAGE_SIZE = 25;
  let serverMeta = { page: null, pageSize: null, total: null };

  // Inicializar inputs con el estado
  pageInput.value = PAGE;
  pageSizeInput.value = PAGE_SIZE;

  // Columnas fijas para el endpoint de cursos
  const COURSE_COLUMNS = [
    "nombre",
    "tema_certificacion",
    "nivel_certificacion",
    "tiempo_certificacion",
    "lenguaje_certificacion",
    "aprendizaje_certificacion",
    "habilidades_certificacion",
    "experiencia_certificacion",
    "testimonios_certificacion",
    "contenido_certificacion",
    "modulos_certificacion",
    "universidad_certificacion",
    "empresa_certificacion",
    "plataforma_certificacion",
    "url_certificacion_original",
    "video_certificacion",
    "imagen_final",
    // columnas agregadas desde arrays globales
    "temas",
    "universidades",
    "plataformas"
  ];

  // Utils
  const toStr = v => v == null ? "" : String(v);
  const norm  = s => toStr(s).toLowerCase();
  const escapeHtml = s => toStr(s)
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'","&#039;");

  const buildExactUrl = () => {
    const base = baseInput.value.replace(/\/+$/,'');
    const res  = resourceSel.value.replace(/^\/+/,'');
    const url  = `${base}/${res}`;

    const u = new URL(url);
    u.searchParams.set("page", PAGE);
    u.searchParams.set("pageSize", PAGE_SIZE);
    return u.toString();
  };

  const buildProxyUrl = (externalUrl) => {
    const u = new URL(window.location.origin + '/api/proxy');
    u.searchParams.set('url', externalUrl);
    return u.toString();
  };

  const flatten = (obj, prefix='') => {
    if (obj === null || typeof obj !== 'object') return { [prefix.replace(/\.$/,'')]: obj };
    let out = {};
    for (const [k, v] of Object.entries(obj)) {
      const newKey = prefix ? `${prefix}.${k}` : k;
      if (v && typeof v === 'object' && !Array.isArray(v)) {
        Object.assign(out, flatten(v, newKey));
      } else {
        out[newKey] = v;
      }
    }
    return out;
  };

  const guessColumns = (rows) => {
    const keys = new Set();
    rows.slice(0, 50).forEach(r => Object.keys(flatten(r)).forEach(k => keys.add(k)));
    return Array.from(keys);
  };

  // Para otros endpoints genéricos (no cursos)
  const pickRowsFromResponse = (data) => {
    if (Array.isArray(data?.data?.items)) return data.data.items;
    if (Array.isArray(data?.results))     return data.results;
    if (Array.isArray(data?.data))        return data.data;
    if (Array.isArray(data))              return data;
    const k = data && typeof data === 'object'
      ? Object.keys(data).find(x => Array.isArray(data[x]))
      : null;
    return k ? data[k] : [];
  };

  const applyFilters = (rows) => {
    const q = norm(globalSearch.value);
    if (!q) return rows;
    return rows.filter(r => {
      const flat = flatten(r);
      return Object.values(flat).some(v => v!=null && String(v).toLowerCase().includes(q));
    });
  };

  const renderHead = () => {
    theadRow.innerHTML = COLUMNS.map(c => `<th class="px-3 py-2 font-medium">${c}</th>`).join('');
  };

  const renderTable = () => {
    const filtered = applyFilters(RAW);
    const totalServer = serverMeta.total != null ? serverMeta.total : filtered.length;
    countLabel.textContent = `${filtered.length} registros (total servidor: ${totalServer})`;

    const baseTotal = serverMeta.total != null ? serverMeta.total : filtered.length;
    const pageCount = Math.max(1, Math.ceil(baseTotal / PAGE_SIZE));

    PAGE = Math.min(PAGE, pageCount);

    // Como el servidor ya pagina, usamos lo que llega tal cual
    const pageRows = filtered;

    tbody.innerHTML = pageRows.map(row => {
      const flat = flatten(row);
      const tds = COLUMNS.map(c => {
        let v = flat[c];
        if (typeof v === 'object') v = JSON.stringify(v);
        if (v === undefined) v = '';
        return `<td class="px-3 py-2 align-top">${escapeHtml(String(v))}</td>`;
      }).join('');
      return `<tr class="hover:bg-neutral-950">${tds}</tr>`;
    }).join('') || `<tr><td class="px-3 py-6 text-slate-200 text-sm" colspan="${COLUMNS.length || 1}">Sin resultados.</td></tr>`;

    prevBtn.disabled = PAGE<=1;
    nextBtn.disabled = PAGE>=pageCount;
    pageInfo.textContent = `Página ${PAGE} / ${pageCount}`;
  };

  const renderMeta = () => {
    const parts = [];
    if (serverMeta.page != null)     parts.push(`page: ${serverMeta.page}`);
    if (serverMeta.pageSize != null) parts.push(`pageSize: ${serverMeta.pageSize}`);
    if (serverMeta.total != null)    parts.push(`total: ${serverMeta.total}`);
    metaDiv.textContent = parts.length ? parts.join(' · ') : '—';
  };

  async function load(){
    // Lee valores actuales de los inputs
    const inputPage = parseInt(pageInput.value, 10);
    const inputSize = parseInt(pageSizeInput.value, 10);

    if (!isNaN(inputPage) && inputPage > 0) {
      PAGE = inputPage;
    }
    if (!isNaN(inputSize) && inputSize > 0) {
      PAGE_SIZE = inputSize;
    }

    const exactUrl = buildExactUrl();
    fullUrl.textContent = exactUrl;

    // Validar API Key
    const apiKey = apiKeyInput.value.trim();
    if (!apiKey) {
      examplePre.textContent = 'Error: Debes ingresar una API Key (x-api-key).';
      rawPre.textContent = '';
      return;
    }

    // Reset UI de carga
    tbody.innerHTML = '';
    theadRow.innerHTML = '';
    examplePre.textContent = 'Cargando…';
    rawPre.textContent = '';
    countLabel.textContent = 'Cargando…';
    metaDiv.textContent = '—';
    serverMeta = { page: null, pageSize: null, total: null };

    try {
      const res = await fetch(buildProxyUrl(exactUrl), {
        headers: {
          'Accept': 'application/json',
          'x-api-key': apiKey,
        }
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      // JSON crudo
      rawPre.textContent = JSON.stringify(data, null, 2);

      // Metadatos del servidor (si existen en root)
      if (typeof data.page === 'number')      serverMeta.page = data.page;
      if (typeof data.pageSize === 'number')  serverMeta.pageSize = data.pageSize;
      if (typeof data.total === 'number')     serverMeta.total = data.total;

      // O en data.data.*
      if (data?.data) {
        if (typeof data.data.page === 'number')     serverMeta.page = data.data.page;
        if (typeof data.data.pageSize === 'number') serverMeta.pageSize = data.data.pageSize;
        if (typeof data.data.total === 'number')    serverMeta.total = data.data.total;
      }

      // Sincronizamos PAGE y PAGE_SIZE con lo que diga el servidor, si aplica
      if (serverMeta.page != null) {
        PAGE = serverMeta.page;
        pageInput.value = PAGE;
      }
      if (serverMeta.pageSize != null) {
        PAGE_SIZE = serverMeta.pageSize;
        pageSizeInput.value = PAGE_SIZE;
      }

      renderMeta();

      // LÓGICA ESPECIAL PARA CURSOS (certificaciones + temas/universidades/plataformas)
      if (Array.isArray(data?.certificaciones)) {
        const temasNames = (data.temas || []).map(t => t.nombre).join(', ');
        const universidadesNames = (data.universidades || []).map(u => u.nombre).join(', ');
        const plataformasNames = (data.plataformas || []).map(p => p.nombre).join(', ');

        RAW = data.certificaciones.map(c => ({
          ...c,
          temas: temasNames,
          universidades: universidadesNames,
          plataformas: plataformasNames,
        }));

        COLUMNS = COURSE_COLUMNS.slice(); // columnas fijas
      } else {
        // Fallback genérico para otros endpoints
        const rows = pickRowsFromResponse(data);
        RAW = Array.isArray(rows) ? rows : [];
        COLUMNS = guessColumns(RAW);
      }

      examplePre.textContent = RAW[0] ? JSON.stringify(RAW[0], null, 2) : '{}';

      renderHead();
      renderTable();
    } catch (err) {
      examplePre.textContent = 'Error: ' + err.message;
      RAW = [];
      COLUMNS = [];
      renderHead();
      renderTable();
    }
  }

  // Eventos
  reloadBtn.addEventListener('click', () => {
    PAGE = 1;
    pageInput.value = 1;
    load();
  });

  copyBtn.addEventListener('click', () => {
    const url = buildExactUrl();
    navigator.clipboard.writeText(url);
    copyBtn.textContent = 'Copiado ✔';
    setTimeout(()=>copyBtn.textContent='Copiar URL exacta', 1200);
  });

  globalSearch.addEventListener('input', () => { 
    PAGE = 1; 
    pageInput.value = 1;
    renderTable(); 
  });

  applyBtn.addEventListener('click', () => {
    const newPage = parseInt(pageInput.value, 10);
    const newSize = parseInt(pageSizeInput.value, 10);

    if (!isNaN(newPage) && newPage > 0) {
      PAGE = newPage;
    }
    if (!isNaN(newSize) && newSize > 0) {
      PAGE_SIZE = newSize;
    }

    load();
  });

  prevBtn.addEventListener('click', () => { 
    if (PAGE > 1) { 
      PAGE--;
      pageInput.value = PAGE;
      load();
    }
  });

  nextBtn.addEventListener('click', () => { 
    PAGE++;
    pageInput.value = PAGE;
    load();
  });

  resourceSel.addEventListener('change', () => {
    PAGE = 1;
    pageInput.value = 1;
    load();
  });

  baseInput.addEventListener('change', () => {
    PAGE = 1;
    pageInput.value = 1;
    load();
  });

  // Init
  load();
})();
</script>
</main>
{% endblock %}
