
{% extends "base.html" %}

{% block title %} Inspertor de Endpoints {% endblock %}
{% block header %} Inspertor de Endpoints {% endblock %}

{% block content %}
<main class="bg-trasparent text-slate-900">
  <div class="mx-auto ">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-3">
      <!-- Lado izquierdo -->
      <section class="lg:col-span-1 bg-neutral-950 border border-slate-200 rounded-2xl p-5 shadow-sm text-slate-100">
        <h2 class="text-base font-semibold mb-4 text-slate-100">Opciones</h2>
        <div class="space-y-3">
          <label class="block text-sm">
            <span class="text-slate-100">Base URL</span>
            <input id="base-input" type="text" value="https://rgudwgvtgk.execute-api.us-east-1.amazonaws.com/raul/course-information"
                   class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-indigo-500 bg-neutral-950" />
          </label>

          <label class="block text-sm">
            <span class="text-slate-100">Recurso</span>
            <select id="resource-select"
                    class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm bg-neutral-950 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-indigo-500">
              <option value="certifications" selected>/certifications</option>
              <option value="topics">/topics</option>
              <option value="companies">/companies</option>
              <option value="universities">/universities</option>
              <option value="platforms">/platforms</option>
              <option value="regions">/regions</option>
            </select>
          </label>

          <div class="flex items-center gap-2">
            <button id="reload" class="inline-flex items-center gap-2 rounded-lg border border-slate-300 px-3 py-2 text-sm hover:bg-neutral-950">
              Consultar
            </button>
            <button id="copy-url" class="inline-flex items-center gap-2 rounded-lg border border-slate-300 px-3 py-2 text-sm hover:bg-neutral-950">
              Copiar URL exacta
            </button>
          </div>
        </div>

        <div class="my-5 border-t border-slate-200"></div>

        <div class="space-y-3 ">
          <div>
            <h3 class="text-sm font-semibold text-slate-200">URL consultada</h3>
            <code id="full-url" class="block mt-1 text-xs font-mono text-slate-200 break-words"></code>
          </div>

          <div>
            <h3 class="text-sm font-semibold text-slate-200">Metadatos</h3>
            <p id="meta" class="mt-1 text-sm text-slate-100">—</p>
          </div>

          <div class="space-y-3">
            <details open class="rounded-xl border border-slate-200">
              <summary class="cursor-pointer select-none px-3 py-2 text-sm font-medium text-slate-200">Respuesta completa (JSON crudo)</summary>
              <pre id="raw-json" class="p-3 text-xs bg-neutral-950 overflow-auto" style="max-height: 260px;"></pre>
            </details>

            <details class="rounded-xl border border-slate-200">
              <summary class="cursor-pointer select-none px-3 py-2 text-sm font-medium text-slate-200">Primer item (muestra)</summary>
              <pre id="example" class="p-3 text-xs bg-neutral-950 overflow-auto"></pre>
            </details>
          </div>
        </div>
      </section>

      <!-- Lado derecho -->
      <section class="lg:col-span-3 bg-neutral-950 border border-slate-200 rounded-2xl p-5 shadow-sm">
        <div class="sticky top-0 bg-neutral-950 -m-5 p-5 rounded-t-2xl border-b border-slate-200 z-10 text-slate-100">
          <h2 class="text-base font-semibold">Datos</h2>
          <div class="mt-3 flex flex-wrap items-center gap-3">
            <input id="global-search" type="text" placeholder="Búsqueda global…"
                   class="w-full sm:w-64 rounded-lg border border-slate-300 px-3 py-2 text-sm bg-neutral-950 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-indigo-500" />
            <select id="page-size"
                    class="rounded-lg border border-slate-300 px-3 py-2 text-sm bg-neutral-950 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-indigo-500">
              <option value="10">10 por página</option>
              <option value="25" selected>25 por página</option>
              <option value="50">50 por página</option>
              <option value="100">100 por página</option>
            </select>
            <span id="count" class="text-sm text-slate-100 ml-auto"></span>
          </div>
        </div>

        <div class="overflow-auto pt-[20px] text-slate-100" style="max-height: 70vh;">
          <table class="min-w-full table-auto">
            <thead class="sticky top-[0px] bg-neutral-950 z-10">
              <tr id="thead-row" class="text-left text-sm text-slate-100 border-b border-slate-200"></tr>
            </thead>
            <tbody id="tbody" class="divide-y divide-slate-100 text-sm"></tbody>
          </table>
        </div>

        <div class="mt-6 flex items-center gap-2 text-slate-100">
          <button id="prev" class="rounded-lg border border-slate-300 px-3 py-2 text-sm hover:bg-neutral-950 disabled:opacity-50">Anterior</button>
          <span id="page-info" class="text-sm text-slate-100"></span>
          <button id="next" class="rounded-lg border border-slate-300 px-3 py-2 text-sm hover:bg-neutral-950 disabled:opacity-50">Siguiente</button>
        </div>
      </section>
    </div>
  </div>

<script>
(function(){
  // DOM refs
  const baseInput   = document.getElementById('base-input');
  const resourceSel = document.getElementById('resource-select');
  const reloadBtn   = document.getElementById('reload');
  const copyBtn     = document.getElementById('copy-url');

  const fullUrl   = document.getElementById('full-url');
  const metaDiv   = document.getElementById('meta');
  const rawPre    = document.getElementById('raw-json');
  const examplePre= document.getElementById('example');

  const theadRow  = document.getElementById('thead-row');
  const tbody     = document.getElementById('tbody');

  const globalSearch = document.getElementById('global-search');
  const pageSizeSel  = document.getElementById('page-size');
  const countLabel   = document.getElementById('count');
  const prevBtn      = document.getElementById('prev');
  const nextBtn      = document.getElementById('next');
  const pageInfo     = document.getElementById('page-info');

  // State
  let RAW = [];
  let COLUMNS = [];
  let PAGE = 1;
  let PAGE_SIZE = parseInt(pageSizeSel.value, 10) || 25;
  let serverMeta = { page: null, pageSize: null, total: null };

  // Utils
  const toStr = v => v == null ? "" : String(v);
  const norm  = s => toStr(s).toLowerCase();
  const escapeHtml = s => toStr(s)
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'","&#039;");

  const buildExactUrl = () => {
    const base = baseInput.value.replace(/\/+$/,'');
    const res  = resourceSel.value.replace(/^\/+/,'');
    return `${base}/${res}`;
  };

  const buildProxyUrl = (externalUrl) => {
    const u = new URL(window.location.origin + '/api/proxy');
    u.searchParams.set('url', externalUrl);
    return u.toString();
  };

  const flatten = (obj, prefix='') => {
    if (obj === null || typeof obj !== 'object') return { [prefix.replace(/\.$/,'')]: obj };
    let out = {};
    for (const [k, v] of Object.entries(obj)) {
      const newKey = prefix ? `${prefix}.${k}` : k;
      if (v && typeof v === 'object' && !Array.isArray(v)) {
        Object.assign(out, flatten(v, newKey));
      } else {
        out[newKey] = v;
      }
    }
    return out;
  };

  const guessColumns = (rows) => {
    const keys = new Set();
    rows.slice(0, 50).forEach(r => Object.keys(flatten(r)).forEach(k => keys.add(k)));
    return Array.from(keys);
  };

  const pickRowsFromResponse = (data) => {
    // Formato esperado: { message, data: { items: [...], page, pageSize, total }, ok }
    if (Array.isArray(data?.data?.items)) return data.data.items;
    // Fallbacks
    if (Array.isArray(data?.results)) return data.results;
    if (Array.isArray(data?.data))    return data.data;
    if (Array.isArray(data))          return data;
    const k = data && typeof data === 'object' ? Object.keys(data).find(x => Array.isArray(data[x])) : null;
    return k ? data[k] : [];
  };

  const applyFilters = (rows) => {
    const q = norm(globalSearch.value);
    if (!q) return rows;
    return rows.filter(r => {
      const flat = flatten(r);
      return Object.values(flat).some(v => v!=null && String(v).toLowerCase().includes(q));
    });
  };

  const paginate = (rows) => rows.slice((PAGE-1)*PAGE_SIZE, (PAGE-1)*PAGE_SIZE + PAGE_SIZE);

  const renderHead = () => {
    theadRow.innerHTML = COLUMNS.map(c => `<th class="px-3 py-2 font-medium">${c}</th>`).join('');
  };

  const renderTable = () => {
    const filtered = applyFilters(RAW);
    countLabel.textContent = `${filtered.length} registros (de ${RAW.length})`;
    const pageCount = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
    PAGE = Math.min(PAGE, pageCount);

    const pageRows = paginate(filtered);

    tbody.innerHTML = pageRows.map(row => {
      const flat = flatten(row);
      const tds = COLUMNS.map(c => {
        let v = flat[c];
        if (typeof v === 'object') v = JSON.stringify(v);
        if (v === undefined) v = '';
        return `<td class="px-3 py-2 align-top">${escapeHtml(String(v))}</td>`;
      }).join('');
      return `<tr class="hover:bg-neutral-950">${tds}</tr>`;
    }).join('') || `<tr><td class="px-3 py-6 text-slate-200 text-sm" colspan="${COLUMNS.length}">Sin resultados.</td></tr>`;

    prevBtn.disabled = PAGE<=1;
    nextBtn.disabled = PAGE>=pageCount;
    pageInfo.textContent = `Página ${PAGE} / ${pageCount}`;
  };

  const renderMeta = () => {
    const parts = [];
    if (serverMeta.page != null)     parts.push(`page: ${serverMeta.page}`);
    if (serverMeta.pageSize != null) parts.push(`pageSize: ${serverMeta.pageSize}`);
    if (serverMeta.total != null)    parts.push(`total: ${serverMeta.total}`);
    metaDiv.textContent = parts.length ? parts.join(' · ') : '—';
  };

  async function load(){
    const exactUrl = buildExactUrl();
    fullUrl.textContent = exactUrl;

    // Reset UI
    tbody.innerHTML = '';
    theadRow.innerHTML = '';
    examplePre.textContent = 'Cargando…';
    rawPre.textContent = '';
    countLabel.textContent = 'Cargando…';
    metaDiv.textContent = '—';
    serverMeta = { page: null, pageSize: null, total: null };

    try {
      const res = await fetch(buildProxyUrl(exactUrl), { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      // JSON crudo y metadatos del server
      rawPre.textContent = JSON.stringify(data, null, 2);
      if (data?.data) {
        if (typeof data.data.page === 'number')     serverMeta.page = data.data.page;
        if (typeof data.data.pageSize === 'number') serverMeta.pageSize = data.data.pageSize;
        if (typeof data.data.total === 'number')    serverMeta.total = data.data.total;
      }
      renderMeta();

      // Filas
      const rows = pickRowsFromResponse(data);
      RAW = Array.isArray(rows) ? rows : [];

      examplePre.textContent = RAW[0] ? JSON.stringify(RAW[0], null, 2) : '{}';

      COLUMNS = guessColumns(RAW);
      renderHead();

      PAGE = 1;
      PAGE_SIZE = parseInt(pageSizeSel.value, 10) || 25;
      renderTable();
    } catch (err) {
      examplePre.textContent = 'Error: ' + err.message;
      RAW = [];
      COLUMNS = [];
      renderHead();
      renderTable();
    }
  }

  // Eventos
  reloadBtn.addEventListener('click', load);
  copyBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(buildExactUrl());
    copyBtn.textContent = 'Copiado ✔';
    setTimeout(()=>copyBtn.textContent='Copiar URL exacta', 1200);
  });
  globalSearch.addEventListener('input', () => { PAGE=1; renderTable(); });
  pageSizeSel.addEventListener('change', () => { PAGE_SIZE=parseInt(pageSizeSel.value,10)||25; PAGE=1; renderTable(); });
  prevBtn.addEventListener('click', () => { if (PAGE>1){ PAGE--; renderTable(); } });
  nextBtn.addEventListener('click', () => { PAGE++; renderTable(); });

  resourceSel.addEventListener('change', load);
  baseInput.addEventListener('change', load);

  // Init
  load();
})();
</script>
</main>
{% endblock %}
