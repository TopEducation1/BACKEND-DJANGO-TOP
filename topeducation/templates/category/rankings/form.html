{% load static %}
  {{ ranking_form.media }}
  {{ formset.media }}

<form enctype="multipart/form-data" method="POST">
  {% csrf_token %}

  <div class="grid grid-cols-2 gap-6 cont-form text-white">
    <!-- Columna izquierda: datos del ranking -->
    <div>
      <h3 class="my-2 text-xl font-bold">Datos del Ranking</h3>
      <div class="flex flex-wrap gap-2">
        {% for field in ranking_form %}
          {% if field.name == "image" %}
            <div class="w-full ">
              {{ field.label_tag }}
              {% if field.value %}
                <img id="preview-{{ field.name }}" class="rounded-lg mb-2 w-full" src="{{ field.value.url }}" />
              {% else %}
                <img id="preview-{{ field.name }}" class="rounded-lg mb-2 hidden w-full" />
              {% endif %}
              {{ field }}
            </div>
          {% elif field.name == "tipo" or field.name == "estado" %}
            <div class="w-[48%]">
              {{ field.label_tag }} {{ field }}
            </div>
          {% else %}
            <div class="w-full">
              {{ field.label_tag }} {{ field }}
            </div>
          {% endif %}
          {% for error in field.errors %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded mt-1">{{ error }}</div>
          {% endfor %}
        {% endfor %}
      </div>

      <div class="flex gap-3 w-full mt-8">
        <button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded" type="submit">Guardar</button>
        <a class="bg-neutral-400 hover:bg-neutral-300 text-neutral-900 font-semibold py-2 px-4 rounded" href="{% url 'rankings' %}">Cancelar</a>
      </div>
    </div>

    <!-- Columna derecha: listado del ranking -->
    <div>
      <h3 class="my-2 text-xl font-bold">Listado del Ranking</h3>

      {# ¡Crítico! management form del formset #}
      {{ formset.management_form }}

      <table id="ranking-entries" class="w-full text-sm">
        {% for subform in formset %}
          <tr class="align-top">
            {{ subform.id }}
            <td class="universidad-select py-1 px-2">
              <span class="block text-xs text-neutral-300">{{ subform.universidad.label }}</span>
              {{ subform.universidad }}
            </td>
            <td class="empresa-select py-1 px-2">
              <span class="block text-xs text-neutral-300">{{ subform.empresa.label }}</span>
              {{ subform.empresa }}
            </td>
            <td class="py-1 px-2">
              <span class="block text-xs text-neutral-300">{{ subform.posicion.label }}</span>
              {{ subform.posicion }}
            </td>
            <td class="pt-6 px-2">
              <label class="inline-flex items-center gap-2 bg-red-400/10 px-2 py-1 rounded text-red-400">
                Eliminar {{ subform.DELETE }}
              </label>
            </td>
          </tr>
        {% endfor %}
      </table>

      {# --- CLAVE: usar <template> para que NO se inicialicen los select2 antes de clonar --- #}
      <template id="empty-form-row-template">
        <tr class="align-top">
          <td class="universidad-select p-2">{{ formset.empty_form.universidad }}</td>
          <td class="empresa-select p-2">{{ formset.empty_form.empresa }}</td>
          <td class="p-2">{{ formset.empty_form.posicion }}</td>
          <td class="p-2">
            <label class="inline-flex items-center gap-2 bg-red-400/10 px-2 py-1 rounded text-red-400">
              Eliminar {{ formset.empty_form.DELETE }}
            </label>
            {{ formset.empty_form.id }}
          </td>
        </tr>
      </template>

      <button type="button" id="add-row"
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 mt-4 rounded">
        + Agregar elemento
      </button>
    </div>
  </div>
</form>

<script>
  // Re-init select2 de django-select2
  function initSelect2ForContext(ctx) {
    if (window.jQuery && jQuery.fn) {
      if (jQuery.fn.djangoSelect2) {
        jQuery(ctx).find('select.django-select2').djangoSelect2();
        jQuery(ctx).find('select.django-select2-heavy').djangoSelect2();
      } else if (jQuery.fn.select2) {
        jQuery(ctx).find('select.django-select2, select.django-select2-heavy').select2();
      }
    }
    // Dispara el evento oficial por si la lib lo usa
    try { (ctx || document).dispatchEvent(new Event('django.select2.init', { bubbles: true })); } catch(e) {}
  }

  // Reemplaza __prefix__ en name/id/for y en data-ajax--url (¡clave!)
  function replaceFormsetPrefix(node, index) {
    node.querySelectorAll('input, select, textarea, label').forEach(el => {
      if (el.name) el.name = el.name.replace('__prefix__', index);
      if (el.id) el.id = el.id.replace('__prefix__', index);
      if (el.htmlFor) el.htmlFor = el.htmlFor.replace('__prefix__', index);

      // Para selects de django-select2: actualizar atributos data-ajax--*
      if (el.tagName === 'SELECT') {
        // Limpia estado previo por si acaso
        el.removeAttribute('data-select2-id');
        el.classList.remove('select2-hidden-accessible');
        // Reemplaza __prefix__ en cualquier data-attr relevante
        for (const attr of el.getAttributeNames()) {
          if (attr.startsWith('data-ajax') || attr.includes('field_id') || attr.includes('url')) {
            const val = el.getAttribute(attr);
            if (val && val.includes('__prefix__')) {
              el.setAttribute(attr, val.replace(/__prefix__/g, index));
            }
          }
        }
        // Deja sin selección
        el.selectedIndex = -1;
      } else if (el.type === 'checkbox') {
        el.checked = false;
      } else if (el.type && el.type !== 'hidden') {
        el.value = '';
      }
    });

    // Vacía PK oculto para nuevas filas
    const hiddenPk = node.querySelector(`input[name$="-${index}-id"]`);
    if (hiddenPk) hiddenPk.value = "";
  }

  document.getElementById('add-row').addEventListener('click', function() {
    const table = document.getElementById('ranking-entries');
    const template = document.getElementById('empty-form-row-template');

    const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
    const totalName = totalFormsInput.getAttribute('name'); // ej: entries-TOTAL_FORMS
    const prefix = totalName.replace(/-TOTAL_FORMS$/, '');
    const index = parseInt(totalFormsInput.value, 10);

    const newRow = template.content.firstElementChild.cloneNode(true);

    // Reemplaza __prefix__ en TODOS los lugares (incl. data-ajax--url)
    replaceFormsetPrefix(newRow, index);

    // Inserta y sube el contador
    table.appendChild(newRow);
    totalFormsInput.value = index + 1;

    // Re-inicializa solo en la fila nueva
    initSelect2ForContext(newRow);
  });

  document.addEventListener('DOMContentLoaded', function () {
    initSelect2ForContext(document.body);
  });

  

  document.addEventListener('DOMContentLoaded', function () {
    // Inicial global (por si acaso)
    initSelect2ForContext(document.body);

    const tipoRanking = document.getElementById('id_tipo');
    if (tipoRanking) tipoRanking.addEventListener('change', toggleSelects);
    toggleSelects();
  });

  // --- Preview de imagen ---
  function previewImage(event, fieldName) {
    const input = event.target;
    const imgPreview = document.getElementById('preview-' + fieldName);
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        imgPreview.src = e.target.result;
        imgPreview.classList.remove('hidden');
      }
      reader.readAsDataURL(input.files[0]);
    }
  }
</script>
