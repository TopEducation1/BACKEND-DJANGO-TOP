<form enctype="multipart/form-data" method="POST">
  {% csrf_token %}
  <div class="mt-3 grid grid-cols-2 gap-x-6 gap-y-4  cont-form text-white">

    <!-- Primera columna: ocupa 1/3 -->
    <div class="col-span-1 gap-4">
      <div class="sticky top-10">
        <h3 class="my-2 text-xl font-bold">Datos del Ranking</h3>
        <div class="flex flex-wrap gap-2">
          {% for field in ranking_form %}
            {% if field.name == "image" %}
              <div class="w-full">
                {{ field.label_tag }}
                {% if field.value %}
                  <img id="preview-{{ field.name }}" class="rounded-lg mb-2 w-full" src="{{ field.value.url }}" />
                {% else %}
                    <img id="preview-{{ field.name }}" src="#" class="rounded-lg mb-2 hidden w-full" />
                {% endif %}
                <input 
                  type="file" 
                  name="{{ field.name }}" 
                  id="{{ field.id_for_label }}" 
                  class="w-full border border-white bg-white text-neutral-950 rounded-lg px-4 py-1" 
                  onchange="previewImage(event, '{{ field.name }}')"
                >
              </div>
            {% elif field.name == "tipo" or field.name == "estado" %}
              <div class="w-[48%]">
                {{ field.label_tag }}
                {{ field }}
              </div>
            {% else %}
              <div class="w-full">
                {{ field.label_tag }}
                {{ field }}
              </div>
            {% endif %}
            {% for error in field.errors %}
              <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">{{ error }}</div>
            {% endfor %}
          {% endfor %}
        </div>
        <div class="flex flex-wrap gap-3 w-full mt-8">
          <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" type="submit">Guardar</button>
          <a class="bg-neutral-500 hover:bg-neutral-400 text-neutral-950 font-bold py-2 px-4 rounded-lg" href="{% url 'rankings' %}">Cancelar</a>
        </div>
      </div>
    </div>

    <!-- Segunda columna: ocupa 2/3 -->
    <div class="col-span-1 gap-4">
        <h3 class="my-2 text-xl font-bold">Listado del Ranking</h3>
        {{ formset.management_form }} 
        
        <table id="ranking-entries">
            {% for subform in formset %}
                <tr>
                  {{ subform.id }} 
                    <td class="universidad-select py-1 px-2"><span>{{ subform.universidad.label }}</span>{{ subform.universidad }}</td>
                    <td class="empresa-select py-1 px-2"><span>{{ subform.empresa.label }}</span>{{ subform.empresa }}</td>
                    <td class="py-1 px-2"><span>{{ subform.posicion.label }}</span>{{ subform.posicion }}</td>
                    <td class="pt-5 px-2">
                        {% if subform.instance.pk %}
                        <span class="inline-flex items-center rounded-md gap-2 bg-red-400/10 px-2 py-1 block text-md font-medium text-red-400 inset-ring inset-ring-red-400/20">
                            Eliminar:  {{ subform.DELETE }}</span>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </table>
        <table style="display:none;">
      <tr id="empty-form-row">
        <td class="universidad-select p-2">
          {{ formset.empty_form.universidad }}
        </td>
        <td class="empresa-select p-2">
          {{ formset.empty_form.empresa }}
        </td>
        <td class="p-2">
          {{ formset.empty_form.posicion }}
        </td>
        <td class="p-2">
          <span class="inline-flex items-center rounded-md gap-2 bg-red-400/10 px-2 py-1 text-md font-medium text-red-400 inset-ring inset-ring-red-400/20">
          Eliminar{{ formset.empty_form.DELETE }}</span>
        </td>
      </tr>
    </table>
    <button type="button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 mt-5 rounded-lg" id="add-row">+ Agregar elemento</button>
    
  </div>
    {% if field.errors %}
      <div class="text-danger text-white">{{ field.errors }}</div>
    {% endif %}
  </div>
</form>


<script>
document.getElementById('add-row').addEventListener('click', function() {
  const prefix = 'entries';
  const table = document.getElementById('ranking-entries');
  const totalFormsInput = document.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`);
  let totalForms = parseInt(totalFormsInput.value);

  const emptyRow = document.getElementById('empty-form-row');
  const newRow = emptyRow.cloneNode(true);
  newRow.style.display = '';

  newRow.querySelectorAll('input, select, textarea, label').forEach(el => {
    if(el.name) el.name = el.name.replace('__prefix__', totalForms);
    if(el.id) el.id = el.id.replace('__prefix__', totalForms);
    if(el.htmlFor) el.htmlFor = el.htmlFor.replace('__prefix__', totalForms);

    if(el.type !== 'hidden' && el.type !== 'checkbox') el.value = '';
    if(el.type === 'checkbox') el.checked = false;
  });

  // Eliminar input hidden 'id' SOLO para filas nuevas
  newRow.querySelectorAll('input[type=hidden]').forEach(input => {
    if(input.name.includes('id')) input.remove();
  });

  table.appendChild(newRow);
  totalFormsInput.value = totalForms + 1;
});

</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const tipoRanking = document.getElementById('id_tipo');

    function toggleSelects() {
        const tipo = tipoRanking.value;
        const universidadSelects = document.querySelectorAll('.universidad-select select');
        const empresaSelects = document.querySelectorAll('.empresa-select select');

        if (tipo === 'universidad') {
            universidadSelects.forEach(sel => sel.closest('td').style.display = 'block');
            empresaSelects.forEach(sel => sel.closest('td').style.display = 'none');
        } 
        else if (tipo === 'empresa') {
            universidadSelects.forEach(sel => sel.closest('td').style.display = 'none');
            empresaSelects.forEach(sel => sel.closest('td').style.display = 'block');
        } 
        else {
            universidadSelects.forEach(sel => sel.closest('td').style.display = 'block');
            empresaSelects.forEach(sel => sel.closest('td').style.display = 'block');
        }
    }

    // Detectar cambios
    tipoRanking.addEventListener('change', toggleSelects);

    // Ejecutar al cargar
    toggleSelects();
});
function previewImage(event, fieldName) {
    const input = event.target;
    const imgPreview = document.getElementById('preview-' + fieldName);

    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        imgPreview.src = e.target.result;
        imgPreview.classList.remove('hidden'); // por si estaba oculta
      }
      reader.readAsDataURL(input.files[0]);
    }
  }
</script>

