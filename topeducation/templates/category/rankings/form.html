{% load static %}
  {{ ranking_form.media }}
  {{ formset.media }}

<form enctype="multipart/form-data" method="POST">
  {% csrf_token %}

  <div class="grid grid-cols-2 gap-6 cont-form text-white">
    <!-- Columna izquierda: datos del ranking -->
    <div>
      <h3 class="my-2 text-xl font-bold">Datos del Ranking</h3>
      <div class="flex flex-wrap gap-2">
        {% for field in ranking_form %}
          {% if field.name == "image" %}
            <div class="w-full ">
              {{ field.label_tag }}
              {% if field.value %}
                <img id="preview-{{ field.name }}" class="rounded-lg mb-2 w-full" src="{{ field.value.url }}" />
              {% else %}
                <img id="preview-{{ field.name }}" class="rounded-lg mb-2 hidden w-full" />
              {% endif %}
              {{ field }}
            </div>
          {% elif field.name == "tipo" or field.name == "estado" %}
            <div class="w-[48%]">
              {{ field.label_tag }} {{ field }}
            </div>
          {% else %}
            <div class="w-full">
              {{ field.label_tag }} {{ field }}
            </div>
          {% endif %}
          {% for error in field.errors %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded mt-1">{{ error }}</div>
          {% endfor %}
        {% endfor %}
      </div>

      <div class="flex gap-3 w-full mt-8">
        <button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded" type="submit">Guardar</button>
        <a class="bg-neutral-400 hover:bg-neutral-300 text-neutral-900 font-semibold py-2 px-4 rounded" href="{% url 'rankings' %}">Cancelar</a>
      </div>
    </div>

    <!-- Columna derecha: listado del ranking -->
    <div>
      <h3 class="my-2 text-xl font-bold">Listado del Ranking</h3>

      {# ¡Crítico! management form del formset #}
      {{ formset.management_form }}

      <table id="ranking-entries" class="w-full text-sm">
        {% for subform in formset %}
          <tr class="align-top">
            {{ subform.id }}
            <td class="universidad-select w-[80%] py-1 px-2">
              <span class="block text-xs text-neutral-300">{{ subform.universidad.label }}</span>
              {{ subform.universidad }}
            </td>
            <td class="empresa-select w-[80%] py-1 px-2">
              <span class="block text-xs text-neutral-300">{{ subform.empresa.label }}</span>
              {{ subform.empresa }}
            </td>
            <td class="py-1 w-[10%] px-2">
              <span class="block text-xs text-neutral-300">{{ subform.posicion.label }}</span>
              {{ subform.posicion }}
            </td>
            <td class="pt-6 w-[5%] px-2">
              <label class="inline-flex items-center gap-2 bg-red-400/10 px-2 py-1 rounded text-red-400">
                Eliminar {{ subform.DELETE }}
              </label>
            </td>
          </tr>
        {% endfor %}
      </table>
      {# --- CLAVE: usar <template> para que NO se inicialicen los select2 antes de clonar --- #}
      <template id="empty-form-row-template">
        <tr class="align-top">
          <td class="universidad-select w-[80%] p-2">{{ formset.empty_form.universidad }}</td>
          <td class="empresa-select w-[80%] p-2">{{ formset.empty_form.empresa }}</td>
          <td class="p-2 w-[10%]">{{ formset.empty_form.posicion }}</td>
          <td class="p-2 w-[5%]">
            <label class="inline-flex items-center gap-2 bg-red-400/10 px-2 py-1 rounded text-red-400">
              Eliminar {{ formset.empty_form.DELETE }}
            </label>
            {{ formset.empty_form.id }}
          </td>
        </tr>
      </template>

      <button type="button" id="add-row"
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 mt-4 rounded">
        + Agregar elemento
      </button>
    </div>
  </div>
</form>

<script>
  // Init SOLO con django-select2 (nunca .select2())
  function initSelect2ForContext(ctx) {
    if (!window.jQuery || !jQuery.fn || !jQuery.fn.djangoSelect2) {
      setTimeout(() => initSelect2ForContext(ctx), 50);
      return;
    }
    jQuery(ctx).find('select.django-select2, select.django-select2-heavy').each(function() {
      const $el = jQuery(this);
      if ($el.data('select2')) {
        // destruye instancia previa por si acaso
        $el.select2('destroy');
      }
      $el.djangoSelect2(); // ← esto añade ?field_id=TOKEN automáticamente
    });
    try { (ctx || document).dispatchEvent(new Event('django.select2.init', { bubbles: true })); } catch (e) {}
  }

  // NO alterar data-field_id (es un token firmado). Solo reemplaza __prefix__ y limpia.
  function patchFormsetAttrs(el, index) {
    if (el.name) el.name = el.name.replace(/__prefix__/g, index);
    if (el.id) el.id = el.id.replace(/__prefix__/g, index);
    if (el.htmlFor) el.htmlFor = el.htmlFor.replace(/__prefix__/g, index);

    if (el.tagName === 'SELECT') {
      // limpia rastros de select2 en el clon
      el.removeAttribute('data-select2-id');
      el.removeAttribute('tabindex');
      el.classList.remove('select2-hidden-accessible');
      el.selectedIndex = -1;

      // IMPORTANTE: NO hagas el.setAttribute('data-field_id', ...).
      // Deja el token tal cual vino en el <template> (django-select2 lo generó en el servidor).

      // Si tu plantilla trae data-ajax--url con field_id, no hace falta tocarlo.
      // El plugin usa data-field_id para construir la URL final.
    } else if (el.type === 'checkbox') {
      el.checked = false;
    } else if (el.type && el.type !== 'hidden') {
      el.value = '';
    }
  }

  function toggleSelects() {
    const tipoRanking = document.getElementById('id_tipo');
    const tipo = tipoRanking ? tipoRanking.value : '';
    const universidadSelects = document.querySelectorAll('.universidad-select');
    const empresaSelects = document.querySelectorAll('.empresa-select');

    if (tipo === 'universidad') {
      universidadSelects.forEach(td => td.style.display = 'table-cell');
      empresaSelects.forEach(td => td.style.display = 'none');
    } else if (tipo === 'empresa') {
      universidadSelects.forEach(td => td.style.display = 'none');
      empresaSelects.forEach(td => td.style.display = 'table-cell');
    } else {
      universidadSelects.forEach(td => td.style.display = 'table-cell');
      empresaSelects.forEach(td => td.style.display = 'table-cell');
    }
  }

  document.getElementById('add-row').addEventListener('click', function () {
    const table = document.getElementById('ranking-entries');
    const template = document.getElementById('empty-form-row-template');
    const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
    const index = parseInt(totalFormsInput.value, 10);

    const newRow = template.content.firstElementChild.cloneNode(true);

    newRow.querySelectorAll('input, select, textarea, label').forEach(el => patchFormsetAttrs(el, index));

    // limpia PK oculto
    const hiddenPk = newRow.querySelector(`input[name$="-${index}-id"]`);
    if (hiddenPk) hiddenPk.value = "";

    table.appendChild(newRow);
    totalFormsInput.value = index + 1;

    // Re-init solo en la fila nueva
    initSelect2ForContext(newRow);
    toggleSelects();
  });

  document.addEventListener('DOMContentLoaded', function () {
    initSelect2ForContext(document.body); // inicializa filas existentes
    const tipoRanking = document.getElementById('id_tipo');
    if (tipoRanking) tipoRanking.addEventListener('change', toggleSelects);
    toggleSelects();
  });

  // Preview imagen (igual que tenías)
  function previewImage(event, fieldName) {
    const input = event.target, img = document.getElementById('preview-' + fieldName);
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = e => { img.src = e.target.result; img.classList.remove('hidden'); };
      reader.readAsDataURL(input.files[0]);
    }
  }
</script>


