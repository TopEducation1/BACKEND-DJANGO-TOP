{% load static %}
  {{ ranking_form.media }}
  {{ formset.media }}

<form enctype="multipart/form-data" method="POST">
  {% csrf_token %}

  <div class="grid grid-cols-2 gap-6 cont-form text-white">
    <!-- Columna izquierda: datos del ranking -->
    <div>
      <h3 class="my-2 text-xl font-bold">Datos del Ranking</h3>
      <div class="flex flex-wrap gap-2">
        {% for field in ranking_form %}
          {% if field.name == "image" %}
            <div class="w-full ">
              {{ field.label_tag }}
              {% if field.value %}
                <img id="preview-{{ field.name }}" class="rounded-lg mb-2 w-full" src="{{ field.value.url }}" />
              {% else %}
                <img id="preview-{{ field.name }}" class="rounded-lg mb-2 hidden w-full" />
              {% endif %}
              {{ field }}
            </div>
          {% elif field.name == "tipo" or field.name == "estado" %}
            <div class="w-[48%]">
              {{ field.label_tag }} {{ field }}
            </div>
          {% else %}
            <div class="w-full">
              {{ field.label_tag }} {{ field }}
            </div>
          {% endif %}
          {% for error in field.errors %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded mt-1">{{ error }}</div>
          {% endfor %}
        {% endfor %}
      </div>

      <div class="flex gap-3 w-full mt-8">
        <button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded" type="submit">Guardar</button>
        <a class="bg-neutral-400 hover:bg-neutral-300 text-neutral-900 font-semibold py-2 px-4 rounded" href="{% url 'rankings' %}">Cancelar</a>
      </div>
    </div>

    <!-- Columna derecha: listado del ranking -->
    <div>
      <h3 class="my-2 text-xl font-bold">Listado del Ranking</h3>

      {# ¡Crítico! management form del formset #}
      {{ formset.management_form }}

      <table id="ranking-entries" class="w-full text-sm">
        {% for subform in formset %}
          <tr class="align-top">
            {{ subform.id }}
            <td class="universidad-select py-1 px-2">
              <span class="block text-xs text-neutral-300">{{ subform.universidad.label }}</span>
              {{ subform.universidad }}
            </td>
            <td class="empresa-select py-1 px-2">
              <span class="block text-xs text-neutral-300">{{ subform.empresa.label }}</span>
              {{ subform.empresa }}
            </td>
            <td class="py-1 px-2">
              <span class="block text-xs text-neutral-300">{{ subform.posicion.label }}</span>
              {{ subform.posicion }}
            </td>
            <td class="pt-6 px-2">
              <label class="inline-flex items-center gap-2 bg-red-400/10 px-2 py-1 rounded text-red-400">
                Eliminar {{ subform.DELETE }}
              </label>
            </td>
          </tr>
        {% endfor %}
      </table>

      {# --- CLAVE: usar <template> para que NO se inicialicen los select2 antes de clonar --- #}
      <template id="empty-form-row-template">
        <tr class="align-top">
          <td class="universidad-select p-2">{{ formset.empty_form.universidad }}</td>
          <td class="empresa-select p-2">{{ formset.empty_form.empresa }}</td>
          <td class="p-2">{{ formset.empty_form.posicion }}</td>
          <td class="p-2">
            <label class="inline-flex items-center gap-2 bg-red-400/10 px-2 py-1 rounded text-red-400">
              Eliminar {{ formset.empty_form.DELETE }}
            </label>
            {{ formset.empty_form.id }}
          </td>
        </tr>
      </template>

      <button type="button" id="add-row"
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 mt-4 rounded">
        + Agregar elemento
      </button>
    </div>
  </div>
</form>

<script>
  // Inicializa SOLO con django-select2 (nunca .select2())
  function initSelect2ForContext(ctx) {
    if (!window.jQuery || !jQuery.fn || !jQuery.fn.djangoSelect2) {
      // si los assets aún no cargaron, reintenta un momento después
      setTimeout(() => initSelect2ForContext(ctx), 50);
      return;
    }
    jQuery(ctx).find('select.django-select2, select.django-select2-heavy').each(function () {
      const $el = jQuery(this);
      if ($el.data('select2')) {
        // por si hubiera una instancia previa (raro al usar <template>)
        $el.djangoSelect2('destroy');
      }
      $el.djangoSelect2(); // ← esto agrega ?field_id=... automáticamente
    });

    // evento estándar por si algún script lo usa
    try { (ctx || document).dispatchEvent(new Event('django.select2.init', { bubbles: true })); } catch (e) {}
  }

  // Parchea atributos del formset y de select2 (field_id / ajax url)
  function patchFieldAttrs(el, index) {
    if (el.name) el.name = el.name.replace(/__prefix__/g, index);
    if (el.id) el.id = el.id.replace(/__prefix__/g, index);
    if (el.htmlFor) el.htmlFor = el.htmlFor.replace(/__prefix__/g, index);

    if (el.tagName === 'SELECT') {
      // limpiar rastros del clon
      el.removeAttribute('data-select2-id');
      el.removeAttribute('tabindex');
      el.classList.remove('select2-hidden-accessible');
      el.selectedIndex = -1;

      // CLAVE: data-field_id debe coincidir con el name actual
      el.setAttribute('data-field_id', el.name);

      // Si el widget dejó data-ajax--url con field_id en la query, lo sincronizamos.
      // (No es estrictamente necesario; djangoSelect2 usará data-field_id, pero esto evita incongruencias)
      const urlAttr = el.getAttribute('data-ajax--url') || el.getAttribute('data-url');
      if (urlAttr) {
        const abs = urlAttr.startsWith('http') ? urlAttr : (window.location.origin + urlAttr);
        let u;
        try { u = new URL(abs); } catch (e) { u = null; }
        if (u) {
          const fid = u.searchParams.get('field_id');
          if (fid) {
            u.searchParams.set('field_id', el.name);
            const relative = u.pathname + '?' + u.searchParams.toString();
            el.setAttribute('data-ajax--url', relative);
          }
        }
      }
    } else if (el.type === 'checkbox') {
      el.checked = false;
    } else if (el.type && el.type !== 'hidden') {
      el.value = '';
    }
  }

  // Mostrar/ocultar columnas según el "tipo" del ranking
  function toggleSelects() {
    const tipoRanking = document.getElementById('id_tipo');
    const tipo = tipoRanking ? tipoRanking.value : '';
    const universidadSelects = document.querySelectorAll('.universidad-select');
    const empresaSelects = document.querySelectorAll('.empresa-select');

    if (tipo === 'universidad') {
      universidadSelects.forEach(td => td.style.display = 'table-cell');
      empresaSelects.forEach(td => td.style.display = 'none');
    } else if (tipo === 'empresa') {
      universidadSelects.forEach(td => td.style.display = 'none');
      empresaSelects.forEach(td => td.style.display = 'table-cell');
    } else {
      universidadSelects.forEach(td => td.style.display = 'table-cell');
      empresaSelects.forEach(td => td.style.display = 'table-cell');
    }
  }

  // Agregar filas dinámicas del formset
  document.getElementById('add-row').addEventListener('click', function () {
    const table = document.getElementById('ranking-entries');
    const template = document.getElementById('empty-form-row-template');

    const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
    const index = parseInt(totalFormsInput.value, 10);

    // clonar desde <template> (evita que ya venga inicializado)
    const newRow = template.content.firstElementChild.cloneNode(true);

    // Reemplazar __prefix__ y parchear select2 attrs
    newRow.querySelectorAll('input, select, textarea, label').forEach(el => patchFieldAttrs(el, index));

    // Vaciar PK oculto
    const hiddenPk = newRow.querySelector(`input[name$="-${index}-id"]`);
    if (hiddenPk) hiddenPk.value = "";

    // Insertar y subir el contador
    table.appendChild(newRow);
    totalFormsInput.value = index + 1;

    // Inicializar django-select2 SOLO en esta fila nueva
    initSelect2ForContext(newRow);

    // Respetar visibilidad por tipo
    toggleSelects();
  });

  document.addEventListener('DOMContentLoaded', function () {
    initSelect2ForContext(document.body);  // inicial de todos los selects renderizados
    const tipoRanking = document.getElementById('id_tipo');
    if (tipoRanking) tipoRanking.addEventListener('change', toggleSelects);
    toggleSelects();
  });

  // Preview de imagen
  function previewImage(event, fieldName) {
    const input = event.target;
    const imgPreview = document.getElementById('preview-' + fieldName);
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function (e) {
        imgPreview.src = e.target.result;
        imgPreview.classList.remove('hidden');
      }
      reader.readAsDataURL(input.files[0]);
    }
  }
</script>

